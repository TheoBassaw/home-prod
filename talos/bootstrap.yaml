---
- name: Apply Talos Config
  ansible.builtin.import_playbook: apply-config.yaml

- name: Bootstrap Talos Cluster
  become: false
  hosts: localhost
  tasks:
    - name: Bootstrap | Bootstrap talos controlplane
      until: bootstrap is success
      delay: 30
      retries: 30
      register: bootstrap
      ansible.builtin.command: talosctl bootstrap --talosconfig=clusterconfig/talosconfig --nodes={{ nodes.0.ipAddress }}
      changed_when:
        - bootstrap.rc == 0
        - bootstrap.stderr_lines[1] | regex_search("AlreadyExists") is none
      failed_when:
        - bootstrap.rc == 1
        - bootstrap.stderr_lines[1] | regex_search("AlreadyExists") is none

    - name: Bootstrap | Get kubeconfig
      ansible.builtin.command: talosctl kubeconfig --force --talosconfig=clusterconfig/talosconfig --nodes={{ nodes.0.ipAddress }}
      changed_when: false

    - name: Bootstrap | Add cilium helm repo
      kubernetes.core.helm_repository:
        name: cilium
        repo_url: https://helm.cilium.io/

    - name: Bootstrap | Generate cilium manifests
      kubernetes.core.helm_template:
        name: cilium
        chart_ref: cilium/cilium
        chart_version: 1.18.5
        release_namespace: kube-system
        update_repo_cache: true
        values_files: ../kubernetes/kube-system/cilium/helm-values.yaml
        include_crds: true
      register: cilium_manifests

    - name: Bootstrap | Generate flux operator manifest
      kubernetes.core.helm_template:
        name: flux-operator
        chart_ref: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator
        chart_version: 0.38.1
        release_namespace: flux-system
        update_repo_cache: true
      register: flux_operator_manifests

    - name: Bootstrap | Apply Manifests
      kubernetes.core.k8s:
        state: present
        definition: "{{ item }}"
      loop:
        - "{{ cilium_manifests.stdout | from_yaml_all }}"
        - "{{ flux_operator_manifests.stdout | from_yaml_all }}"
        - "{{ lookup('file', 'flux-seed.yaml') | from_yaml_all }}"
      delay: 30
      retries: 30
