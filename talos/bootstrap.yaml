---
- name: Apply Talos Config
  ansible.builtin.import_playbook: apply-config.yaml

- name: Bootstrap Talos Cluster
  become: false
  hosts: localhost
  tasks:
    - name: Bootstrap | Bootstrap talos controlplane
      until: bootstrap is success
      delay: 30
      retries: 30
      register: bootstrap
      ansible.builtin.command: talosctl bootstrap --talosconfig={{ clusterconfig/talosconfig --nodes={{ nodes.0.ip_address }}
      changed_when:
        - bootstrap.rc == 0
        - bootstrap.stderr_lines[1] | regex_search("AlreadyExists") is none
      failed_when:
        - bootstrap.rc == 1
        - bootstrap.stderr_lines[1] | regex_search("AlreadyExists") is none

    - name: Bootstrap | Get kubeconfig
      ansible.builtin.command: talosctl kubeconfig --force --talosconfig=clusterconfig/talosconfig --nodes={{ nodes.0.ip_address }}
      changed_when: false

- name: Apply K8S Manifests
  ansible.builtin.import_playbook: apply-manifests.yaml
