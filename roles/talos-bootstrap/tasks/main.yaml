- name: Bootstrap | Generate & Store Talosconfig
  block:
    - name: Bootstrap | Generate Talosconfig
      ansible.builtin.command: topf talosconfig
      args:
        chdir: "talos/{{ cluster_name }}"
      changed_when: false
      register: talosconfig

    - name: Bootstrap | Store Talosconfig
      ansible.builtin.copy:
        content: "{{ talosconfig.stdout }}"
        dest: "talos/{{ cluster_name }}/talosconfig"
        mode: "0644"

- name: Bootstrap | Apply Cluster Configs
  ansible.builtin.command: topf apply --confirm=false --auto-bootstrap=true --allow-not-ready=true
  args:
    chdir: "talos/{{ cluster_name }}"
  changed_when: false

- name: Bootstrap | Generate & Store Kubeconfig
  block:
    - name: Bootstrap | Generate Kubeconfig
      ansible.builtin.command: topf kubeconfig --validity=8760h
      args:
        chdir: "talos/{{ cluster_name }}"
      changed_when: false
      register: kubeconfig

    - name: Bootstrap | Store Kubeconfig
      ansible.builtin.copy:
        content: "{{ kubeconfig.stdout }}"
        dest: "talos/{{ cluster_name }}/kubeconfig"
        mode: "0644"
