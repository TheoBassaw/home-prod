- name: Bootstrap | Apply cluster configs (insecure)
  register: apply
  ansible.builtin.command: |
    talosctl apply-config -i -n {{ item.ip_address }} -f {{ cluster_name }}/clusterconfig/{{ item.hostname }}.yaml
  changed_when:
    - apply.rc == 0
  failed_when:
    - apply.rc == 1
    - apply.stderr_lines[0] | regex_search("certificate required") is none
  loop: "{{ nodes }}"

- name: Bootstrap | Bootstrap talos controlplane
  until: bootstrap is success
  delay: 30
  retries: 30
  register: bootstrap
  ansible.builtin.command: talosctl bootstrap --talosconfig={{ cluster_name }}/clusterconfig/talosconfig --nodes={{ nodes.0.ip_address }}
  changed_when:
    - bootstrap.rc == 0
    - bootstrap.stderr_lines[1] | regex_search("AlreadyExists") is none
  failed_when:
    - bootstrap.rc == 1
    - bootstrap.stderr_lines[1] | regex_search("AlreadyExists") is none

- name: Bootstrap | Get kubeconfig
  ansible.builtin.command: talosctl kubeconfig --force --talosconfig={{ cluster_name }}/clusterconfig/talosconfig --nodes={{ nodes.0.ip_address }}
  changed_when: false
