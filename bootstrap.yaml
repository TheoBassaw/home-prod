---
- name: Create home cluster
  become: false
  hosts: localhost
  tags: home-cluster
  vars_files:
    - vars/home-cluster.yaml
  tasks:
    - name: Talos Bootstrap | Add cilium helm repo
      kubernetes.core.helm_repository:
        name: cilium
        repo_url: https://helm.cilium.io/

    - name: Talos Bootstrap | Apply cilium helm chart
      kubernetes.core.helm:
        name: cilium
        chart_ref: cilium/cilium
        chart_version: "1.17.4"
        release_namespace: kube-system
        update_repo_cache: true
        context: "admin@{{ cluster_name }}"
        kubeconfig: "~/.kube/config"
        wait: true
        values_files:
          - "/kubernetes/apps/kube-system/cilium/helm-values.yaml"
      retries: 30
      delay: 10

    - name: Talos Bootstrap | Apply flux-operator helm chart
      kubernetes.core.helm:
        name: flux-operator
        chart_ref: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator
        chart_version: "0.22.0"
        release_namespace: flux-system
        create_namespace: true
        update_repo_cache: true
        context: "admin@{{ cluster_name }}"
        kubeconfig: "~/.kube/config"
        wait: true

    - name: Talos Bootstrap | Start flux cluster sync
      kubernetes.core.k8s:
        src: "/kubernetes/apps/flux-system/flux-instance.yaml"
        wait: true
