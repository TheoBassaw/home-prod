- become: false
  hosts: localhost
  name: Setup Initial Infrastructure
  tasks:
    - name: Deploying Management Plane
      environment:  
        TF_HTTP_USERNAME: "{{ lookup('ansible.builtin.env', 'GITLAB_USER') }}"
        TF_HTTP_PASSWORD: "{{ lookup('ansible.builtin.env', 'GITLAB_PAT') }}"
      community.general.terraform:
        project_path: 'terraform/management-plane'
        force_init: true
        complex_vars: true
        init_reconfigure: true
        state: present
        variables:
          zerotier_central_token: "{{ lookup('ansible.builtin.env', 'ZEROTIER_CENTRAL_TOKEN') }}"
          vultr_api_key: "{{ lookup('ansible.builtin.env', 'VULTR_API_KEY') }}" 
    - meta: refresh_inventory

- become: true
  hosts: management_plane
  gather_facts: false
  name: Wait For Hosts To Be Available
  tasks:
    - name: Wait For Hosts To Be Availiable
      ansible.builtin.wait_for:
        timeout: 300
        port: 22
        host: "{{ (ansible_ssh_host|default(ansible_host))|default(inventory_hostname) }}"
      connection: local
      become: false

#- become: true
#  hosts: management_plane
#  name: CIS-Hardening
#  vars_files:
#    - vars/cis-hardening-default.yaml
#  roles:
#    - role: UBUNTU22-CIS

#- become: true
#  hosts: ingress_routers
#  name: Configuring Ingress Routers
#  roles:
#    - authoritative-dns
#    - ingress-router

- become: true
  hosts: oci_k8s_masters
  name: Creating Management Cluster
  vars:
    cilium_service_host: "{{ hostvars[groups['oci_k8s_masters'][0]]['ansible_zt0']['ipv4']['address'] }}"
    rke2_init_server: "{{ hostvars[groups['oci_k8s_masters'][0]]['ansible_zt0']['ipv4']['address'] }}"
    kubeconfig_location: "{{ lookup('ansible.builtin.env', 'HOME') }}/.kube/management-cluster.yaml"
    doppler_token: "{{ lookup('ansible.builtin.env', 'MANAGEMENT_CLUSTER_DOPPLER_TOKEN') }}"
    rke2_token: "{{ lookup('ansible.builtin.env', 'MANAGEMENT_CLUSTER_RKE2_TOKEN') }}"
    gitlab_owner: "{{ lookup('ansible.builtin.env', 'GITLAB_USER') }}"
  environment:
    GITLAB_TOKEN: "{{ lookup('ansible.builtin.env', 'GITLAB_PAT') }}"
  roles:
    - k8s