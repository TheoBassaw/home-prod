---
- name: Apply Helm Charts & Manifests
  become: false
  hosts: localhost
  vars:
    charts:
      - name: cilium
        chart_ref: oci://quay.io/cilium/charts/cilium
        chart_version: 1.18.6
        release_namespace: kube-system
        values: "{{ lookup('file', 'kubernetes/kube-system/cilium/app/helmrelease.yaml') | from_yaml | json_query('spec.values') }}"
      - name: spegel
        chart_ref: oci://ghcr.io/spegel-org/helm-charts/spegel
        chart_version: 0.4.0
        release_namespace: spegel
        values: "{{ lookup('file', 'kubernetes/spegel/app/helmrelease.yaml') | from_yaml | json_query('spec.values') }}"
      - name: cert-manager
        chart_ref: oci://quay.io/jetstack/charts/cert-manager
        chart_version: v1.19.2
        release_namespace: cert-manager
        values: "{{ lookup('file', 'kubernetes/cert-manager/app/helmrelease.yaml') | from_yaml | json_query('spec.values') }}"
      - name: piraeus-operator
        chart_ref: oci://ghcr.io/piraeusdatastore/piraeus-operator/piraeus
        chart_version: 2.10.3
        release_namespace: piraeus-datastore
        values: "{{ lookup('file', 'kubernetes/piraeus-datastore/app/helmrelease.yaml') | from_yaml | json_query('spec.values') }}"
      - name: flux-operator
        chart_ref: oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator
        chart_version: 0.38.1
        release_namespace: flux-system
        values: "{{ lookup('file', 'kubernetes/flux-system/app/helmrelease.yaml') | from_yaml | json_query('spec.values') }}"
  tasks:
    - name: Apply-Manifests | Apply helm charts
      kubernetes.core.helm:
        name: "{{ item.name }}"
        chart_ref: "{{ item.chart_ref }}"
        chart_version: "{{ item.chart_version }}"
        release_namespace: "{{ item.release_namespace }}"
        create_namespace: true
        values: "{{ item['values'] }}"
      loop: "{{ charts }}"

    - name: Apply-Manifests | Apply flux seed repo
      kubernetes.core.k8s:
        state: present
        wait: true
        definition:
          apiVersion: fluxcd.controlplane.io/v1
          kind: FluxInstance
          metadata:
            name: flux
            namespace: flux-system
          spec:
            distribution:
              version: 2.x
              registry: ghcr.io/fluxcd
            components:
              - source-controller
              - kustomize-controller
              - helm-controller
              - notification-controller
            cluster:
              type: kubernetes
              multitenant: false
              networkPolicy: true
              domain: cluster.local
            sync:
              kind: GitRepository
              url: https://github.com/TheoBassaw/home-prod.git
              ref: refs/heads/main
              path: kubernetes
              interval: 1h
